<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡∏•‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Kanit', sans-serif;
    }
    * { font-family: 'Kanit', sans-serif; }
    
    html, body, #app {
      width: 100%;
      height: 100%;
    }

    @keyframes slideDown {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .animate-slide { animation: slideDown 0.4s ease-out; }
    .animate-fade { animation: fadeIn 0.4s ease-out; }
    .spinner { animation: spin 1s linear infinite; width: 20px; height: 20px; border: 3px solid #e5e7eb; border-top-color: #3b82f6; border-radius: 50%; }

    input, textarea, select {
      font-family: 'Kanit', sans-serif;
    }

    .error-shake {
      animation: shake 0.3s;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full overflow-auto bg-gradient-to-br from-blue-50 via-white to-blue-100">
  <div id="app" class="w-full h-full flex flex-col"><!-- Toast Container -->
   <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-3"></div><!-- Page: Login -->
   <div id="page-login" class="w-full h-full flex items-center justify-center p-4">
    <div class="w-full max-w-md animate-fade">
     <div class="bg-white rounded-2xl shadow-2xl overflow-hidden border-t-4 border-blue-500"><!-- Header -->
      <div class="bg-gradient-to-r from-blue-500 to-blue-600 p-8 text-center">
       <div class="text-5xl mb-3">
        üìö
       </div>
       <h1 id="app-title" class="text-2xl font-bold text-white">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡∏•‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô</h1>
      </div><!-- Content -->
      <div class="p-8"><!-- Tab Buttons -->
       <div class="flex rounded-lg bg-gray-100 p-1 mb-6 gap-1"><button onclick="switchRole('student')" class="flex-1 py-2 px-4 rounded font-semibold text-sm transition-all role-tab-btn bg-white text-blue-600 shadow" data-role="student"> ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô </button> <button onclick="switchRole('teacher')" class="flex-1 py-2 px-4 rounded font-semibold text-sm transition-all role-tab-btn text-gray-600 hover:text-gray-800" data-role="teacher"> ‡∏Ñ‡∏£‡∏π </button>
       </div><!-- Form: Student Login -->
       <form id="form-student-login" onsubmit="loginStudent(event)" class="space-y-4 role-form" data-role="student">
        <div><label class="block text-sm font-semibold text-gray-700 mb-2">üîë ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label> <input type="text" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition" id="student-id-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô 001" required> <span class="error-msg text-red-500 text-xs mt-1 hidden"></span>
        </div>
        <div><label class="block text-sm font-semibold text-gray-700 mb-2">üÜî ‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label> <input type="text" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition" id="student-citizen-input" placeholder="13 ‡∏´‡∏•‡∏±‡∏Å" maxlength="13" required> <span class="error-msg text-red-500 text-xs mt-1 hidden"></span>
        </div><button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-3 rounded-lg transition-all transform hover:scale-105"> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö </button>
       </form><!-- Form: Teacher Login -->
       <form id="form-teacher-login" onsubmit="loginTeacher(event)" class="space-y-4 role-form hidden" data-role="teacher">
        <div><label class="block text-sm font-semibold text-gray-700 mb-2">üë§ ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label> <input type="text" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition" id="teacher-user-input" placeholder="admin" required> <span class="error-msg text-red-500 text-xs mt-1 hidden"></span>
        </div>
        <div><label class="block text-sm font-semibold text-gray-700 mb-2">üîê ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label> <input type="password" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition" id="teacher-pass-input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required> <span class="error-msg text-red-500 text-xs mt-1 hidden"></span>
        </div><button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-3 rounded-lg transition-all transform hover:scale-105"> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö </button>
        <p class="text-center text-xs text-gray-500 mt-4">‡∏ó‡∏î‡∏™‡∏≠‡∏ö: admin / 1234</p>
       </form>
      </div>
     </div>
    </div>
   </div><!-- Page: Student Dashboard -->
   <div id="page-student" class="hidden w-full h-full flex flex-col overflow-auto">
    <div class="flex-1 p-6 max-w-4xl mx-auto w-full"><!-- Header -->
     <div class="bg-white rounded-xl shadow-md p-6 mb-6 flex justify-between items-center animate-slide">
      <div>
       <h2 class="text-3xl font-bold text-gray-800">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ üëã</h2>
       <p id="student-name-display" class="text-gray-600 mt-1">‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...</p>
      </div><button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white font-bold px-6 py-2 rounded-lg transition"> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö </button>
     </div><!-- Tab Navigation -->
     <div class="flex gap-2 mb-6"><button onclick="switchStudentTab('request')" class="px-6 py-3 bg-blue-500 text-white font-bold rounded-lg shadow student-tab active"> ‚úâÔ∏è ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠ </button> <button onclick="switchStudentTab('history')" class="px-6 py-3 bg-white text-gray-700 font-bold rounded-lg shadow student-tab hover:bg-gray-50"> üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô </button>
     </div><!-- Tab: Request Form -->
     <div id="student-tab-request" class="student-tab-content">
      <div class="bg-white rounded-xl shadow-md p-8">
       <h3 class="text-2xl font-bold text-gray-800 mb-6">üìù ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏≠‡∏•‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô</h3>
       <form id="form-request" onsubmit="submitRequest(event)" class="space-y-8"><!-- Section: Student Info -->
        <fieldset class="border-2 border-blue-200 rounded-lg p-6 bg-blue-50"><legend class="text-lg font-bold text-blue-700 px-2">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</legend>
         <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
          <div><label class="block text-sm font-semibold text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *</label> <input type="text" id="field-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" required> <span class="field-error text-red-500 text-xs mt-1 hidden"></span>
          </div>
          <div><label class="block text-sm font-semibold text-gray-700 mb-2">‡∏ä‡∏±‡πâ‡∏ô/‡∏´‡πâ‡∏≠‡∏á *</label> <input type="text" id="field-class" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏°.3/1" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" required> <span class="field-error text-red-500 text-xs mt-1 hidden"></span>
          </div>
         </div>
        </fieldset><!-- Section: Leave Details -->
        <fieldset class="border-2 border-green-200 rounded-lg p-6 bg-green-50"><legend class="text-lg font-bold text-green-700 px-2">üìÖ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏≤</legend>
         <div class="space-y-6 mt-4">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
           <div><label class="block text-sm font-semibold text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤ *</label> <input type="date" id="field-date" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none" required> <span class="field-error text-red-500 text-xs mt-1 hidden"></span>
           </div>
           <div><label class="block text-sm font-semibold text-gray-700 mb-2">‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å *</label> <input type="time" id="field-time-out" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none" required> <span class="field-error text-red-500 text-xs mt-1 hidden"></span>
           </div>
           <div><label class="block text-sm font-semibold text-gray-700 mb-2">‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏•‡∏±‡∏ö (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label> <input type="time" id="field-time-back" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none">
           </div>
          </div>
          <div><label class="block text-sm font-semibold text-gray-700 mb-2">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤ *</label> <textarea id="field-reason" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" rows="4" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none" required></textarea> <span class="field-error text-red-500 text-xs mt-1 hidden"></span>
          </div>
         </div>
        </fieldset><!-- Section: Guardian Info -->
        <fieldset class="border-2 border-orange-200 rounded-lg p-6 bg-orange-50"><legend class="text-lg font-bold text-orange-700 px-2">üë®‚Äçüë©‚Äçüëß ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</legend>
         <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
          <div><label class="block text-sm font-semibold text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á *</label> <input type="text" id="field-parent-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏à‡∏¥‡∏ï‡∏ï‡πå ‡πÉ‡∏à‡∏î‡∏µ" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none" required> <span class="field-error text-red-500 text-xs mt-1 hidden"></span>
          </div>
          <div><label class="block text-sm font-semibold text-gray-700 mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ *</label> <input type="tel" id="field-parent-phone" placeholder="0xx-xxx-xxxx" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none" required> <span class="field-error text-red-500 text-xs mt-1 hidden"></span>
          </div>
         </div>
        </fieldset><!-- Section: Image Upload -->
        <fieldset class="border-2 border-purple-200 rounded-lg p-6 bg-purple-50"><legend class="text-lg font-bold text-purple-700 px-2">üì∏ ‡∏£‡∏π‡∏õ‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏£‡∏±‡∏ö</legend>
         <div class="mt-4">
          <div id="upload-area" class="border-3 border-dashed border-purple-400 rounded-lg p-8 text-center cursor-pointer hover:border-purple-600 hover:bg-purple-100 transition" onclick="document.getElementById('file-input').click()"><input type="file" id="file-input" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
           <div id="upload-text">
            <p class="text-4xl mb-3">üì∑</p>
            <p class="text-gray-700 font-semibold">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
            <p class="text-xs text-gray-500 mt-2">(JPG, PNG ‚Ä¢ ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5MB ‚Ä¢ ‡∏à‡∏∞‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</p>
           </div>
           <div id="upload-preview" class="hidden"><img id="preview-image" class="max-h-48 mx-auto rounded-lg mb-3" alt="Preview"> <button type="button" onclick="clearUploadImage()" class="text-red-600 hover:text-red-800 font-semibold text-sm">‚ùå ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ</button>
           </div>
          </div><span id="upload-error" class="text-red-500 text-xs mt-2 hidden"></span>
         </div>
        </fieldset><!-- Submit Button --> <button type="submit" id="btn-submit" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-4 rounded-lg transition-all transform hover:scale-105 text-lg shadow-lg"> ‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠ </button>
       </form>
      </div>
     </div><!-- Tab: History -->
     <div id="student-tab-history" class="student-tab-content hidden">
      <div class="bg-white rounded-xl shadow-md p-8">
       <h3 class="text-2xl font-bold text-gray-800 mb-6">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3>
       <div id="history-list" class="space-y-4">
        <div class="text-center text-gray-400 py-12">
         <p class="text-lg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Page: Teacher Dashboard -->
   <div id="page-teacher" class="hidden w-full h-full flex flex-col overflow-auto">
    <div class="flex-1 p-6 max-w-6xl mx-auto w-full"><!-- Header -->
     <div class="bg-white rounded-xl shadow-md p-6 mb-6 flex justify-between items-center animate-slide">
      <div>
       <h2 class="text-3xl font-bold text-gray-800">üéì ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠</h2>
       <p class="text-gray-600 mt-1">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
      </div><button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white font-bold px-6 py-2 rounded-lg transition"> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö </button>
     </div><!-- Stats -->
     <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-lg shadow p-4 border-t-4 border-gray-400">
       <p class="text-gray-600 text-sm font-semibold">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
       <p id="stat-total" class="text-3xl font-bold text-gray-800 mt-2">0</p>
      </div>
      <div class="bg-yellow-50 rounded-lg shadow p-4 border-t-4 border-yellow-500">
       <p class="text-yellow-700 text-sm font-semibold">‚è≥ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>
       <p id="stat-pending" class="text-3xl font-bold text-yellow-600 mt-2">0</p>
      </div>
      <div class="bg-green-50 rounded-lg shadow p-4 border-t-4 border-green-500">
       <p class="text-green-700 text-sm font-semibold">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</p>
       <p id="stat-approved" class="text-3xl font-bold text-green-600 mt-2">0</p>
      </div>
      <div class="bg-red-50 rounded-lg shadow p-4 border-t-4 border-red-500">
       <p class="text-red-700 text-sm font-semibold">‚ùå ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
       <p id="stat-rejected" class="text-3xl font-bold text-red-600 mt-2">0</p>
      </div>
     </div><!-- Search & Filter -->
     <div class="bg-white rounded-xl shadow-md p-6 mb-6">
      <div class="flex flex-col md:flex-row gap-3"><input type="text" id="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏£‡∏´‡∏±‡∏™ ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏±‡πâ‡∏ô..." class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" oninput="filterRequests()"> <select id="status-select" class="px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" onchange="filterRequests()"> <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option> <option value="pending">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</option> <option value="approved">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</option> <option value="rejected">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option> </select> <input type="date" id="date-select" class="px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" onchange="filterRequests()">
      </div>
     </div><!-- Requests List -->
     <div id="requests-list" class="space-y-4">
      <div class="text-center text-gray-400 py-12">
       <p class="text-lg">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠</p>
      </div>
     </div>
    </div>
   </div>
  </div><!-- Modal: Detail Request -->
  <div id="modal-detail" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[85vh] overflow-y-auto">
    <div class="sticky top-0 bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 flex justify-between items-center">
     <h3 class="text-2xl font-bold">üìÑ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠</h3><button onclick="closeDetailModal()" class="text-2xl hover:opacity-80">‚úï</button>
    </div>
    <div id="modal-detail-content" class="p-6"></div>
   </div>
  </div><!-- Modal: Reject Reason -->
  <div id="modal-reject" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
   <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-8">
    <h3 class="text-2xl font-bold text-gray-800 mb-4">‚ùå ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠</h3>
    <p class="text-gray-600 mb-4">‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</p><textarea id="reject-reason-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö..." rows="4" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-red-500 focus:outline-none"></textarea>
    <div class="flex gap-3 mt-6"><button type="button" onclick="closeRejectModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 rounded-lg transition"> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å </button> <button type="button" onclick="submitReject()" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg transition"> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô </button>
    </div>
   </div>
  </div>
  <script>
    // ========== CONFIG & STATE ==========
    const defaultConfig = { school_name: '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏¢‡∏¢‡∏≠‡∏î‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Ñ‡∏°' };
    let config = { ...defaultConfig };
    let currentUser = null;
    let currentRole = null;
    let allRequests = [];
    let uploadedImage = null;
    let currentRejectId = null;
    let dataSdkReady = false;

    // ========== INITIALIZATION ==========
    async function init() {
      initElementSDK();
      await initDataSDK();
      setDefaultDate();
    }

    function initElementSDK() {
      if (!window.elementSdk) return;
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (newConfig) => {
          config = { ...defaultConfig, ...newConfig };
          updateAppTitle();
        },
        mapToCapabilities: () => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (cfg) => new Map([
          ['school_name', cfg.school_name || defaultConfig.school_name]
        ])
      });
      config = window.elementSdk.config || config;
      updateAppTitle();
    }

    async function initDataSDK() {
      if (!window.dataSdk) {
        console.warn('Data SDK not available');
        dataSdkReady = false;
        return;
      }
      
      try {
        const result = await window.dataSdk.init({
          onDataChanged: (data) => {
            allRequests = (data || []).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            updateAllViews();
          }
        });
        
        if (result.isOk) {
          dataSdkReady = true;
          console.log('Data SDK initialized successfully');
        } else {
          dataSdkReady = false;
          console.error('Data SDK init failed:', result.error);
        }
      } catch (err) {
        dataSdkReady = false;
        console.error('Data SDK error:', err);
      }
    }

    function setDefaultDate() {
      const dateInput = document.getElementById('field-date');
      if (dateInput) {
        dateInput.valueAsDate = new Date();
      }
    }

    // ========== UI SWITCHING ==========
    function switchRole(role) {
      const tabs = document.querySelectorAll('.role-tab-btn');
      const forms = document.querySelectorAll('.role-form');
      
      tabs.forEach(t => {
        if (t.dataset.role === role) {
          t.classList.add('bg-white', 'text-blue-600', 'shadow');
          t.classList.remove('text-gray-600');
        } else {
          t.classList.remove('bg-white', 'text-blue-600', 'shadow');
          t.classList.add('text-gray-600');
        }
      });

      forms.forEach(f => {
        if (f.dataset.role === role) {
          f.classList.remove('hidden');
        } else {
          f.classList.add('hidden');
        }
      });

      clearAllInputs();
    }

    function switchStudentTab(tab) {
      document.querySelectorAll('.student-tab').forEach(b => {
        b.classList.toggle('bg-blue-500', b.dataset?.tab === tab || (tab === 'request' && !b.dataset?.tab));
        b.classList.toggle('text-white', b.dataset?.tab === tab || (tab === 'request' && !b.dataset?.tab));
        b.classList.toggle('bg-white', b.dataset?.tab !== tab && !(tab === 'request' && !b.dataset?.tab));
        b.classList.toggle('text-gray-700', b.dataset?.tab !== tab && !(tab === 'request' && !b.dataset?.tab));
      });

      document.querySelectorAll('.student-tab-content').forEach(c => {
        c.classList.toggle('hidden', !c.id.includes(tab));
      });

      if (tab === 'history') loadStudentHistory();
    }

    function switchPage(page) {
      document.getElementById('page-login').classList.toggle('hidden', page !== 'login');
      document.getElementById('page-student').classList.toggle('hidden', page !== 'student');
      document.getElementById('page-teacher').classList.toggle('hidden', page !== 'teacher');
    }

    // ========== LOGIN & LOGOUT ==========
    function loginStudent(e) {
      e.preventDefault();
      const id = document.getElementById('student-id-input').value.trim();
      const citizen = document.getElementById('student-citizen-input').value.trim();

      if (!id || !citizen) {
        showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'error');
        return;
      }
      if (!/^\d{13}$/.test(citizen)) {
        showToast('‚ùå ‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 13 ‡∏´‡∏•‡∏±‡∏Å', 'error');
        return;
      }

      currentUser = { id, citizen, name: `${id}` };
      currentRole = 'student';
      switchPage('student');
      updateStudentView();
      showToast('‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }

    function loginTeacher(e) {
      e.preventDefault();
      const username = document.getElementById('teacher-user-input').value.trim();
      const password = document.getElementById('teacher-pass-input').value;

      if (username === 'admin' && password === '1234') {
        currentUser = { username };
        currentRole = 'teacher';
        switchPage('teacher');
        updateTeacherView();
        showToast('‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏π‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      } else {
        showToast('‚ùå ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
      }
    }

    function logout() {
      currentUser = null;
      currentRole = null;
      uploadedImage = null;
      clearAllInputs();
      switchPage('login');
      showToast('üëã ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
    }

    // ========== TOAST NOTIFICATION ==========
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      
      const bgColor = type === 'error' ? 'bg-red-500' : type === 'info' ? 'bg-blue-500' : 'bg-green-500';
      toast.className = `${bgColor} text-white px-6 py-4 rounded-lg shadow-lg font-semibold animate-slide text-sm md:text-base`;
      toast.textContent = message;
      
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3500);
    }

    // ========== IMAGE UPLOAD ==========
    function handleImageUpload(e) {
      const file = e.target.files[0];
      if (!file) return;

      const maxSize = 5 * 1024 * 1024;
      if (file.size > maxSize) {
        showToast('‚ùå ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î 5MB)', 'error');
        document.getElementById('file-input').value = '';
        return;
      }

      if (!file.type.startsWith('image/')) {
        showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'error');
        document.getElementById('file-input').value = '';
        return;
      }

      const reader = new FileReader();
      reader.onerror = () => {
        showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error');
        document.getElementById('file-input').value = '';
      };

      reader.onload = (event) => compressImage(event.target.result);
      reader.readAsDataURL(file);
    }

    function compressImage(base64Str) {
      const img = new Image();
      img.onerror = () => {
        showToast('‚ùå ‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
        document.getElementById('file-input').value = '';
      };

      img.onload = () => {
        const canvas = document.createElement('canvas');
        let { width: w, height: h } = img;
        const maxDim = 1200;

        if (w > h) {
          if (w > maxDim) {
            h = Math.round((h * maxDim) / w);
            w = maxDim;
          }
        } else {
          if (h > maxDim) {
            w = Math.round((w * maxDim) / h);
            h = maxDim;
          }
        }

        canvas.width = w;
        canvas.height = h;

        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, w, h);
        ctx.drawImage(img, 0, 0, w, h);

        let quality = 0.8;
        let compressed = canvas.toDataURL('image/jpeg', quality);

        while (compressed.length > 300 * 1024 && quality > 0.2) {
          quality -= 0.1;
          compressed = canvas.toDataURL('image/jpeg', quality);
        }

        if (compressed.length > 300 * 1024) {
          showToast('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πá‡∏Å‡∏Å‡∏ß‡πà‡∏≤', 'error');
          document.getElementById('file-input').value = '';
          return;
        }

        uploadedImage = compressed;
        const sizeKB = Math.round(compressed.length / 1024);
        showToast(`‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${sizeKB}KB)`);

        document.getElementById('preview-image').src = uploadedImage;
        document.getElementById('upload-text').classList.add('hidden');
        document.getElementById('upload-preview').classList.remove('hidden');
      };

      img.src = base64Str;
    }

    function clearUploadImage() {
      uploadedImage = null;
      document.getElementById('file-input').value = '';
      document.getElementById('upload-text').classList.remove('hidden');
      document.getElementById('upload-preview').classList.add('hidden');
    }

    // ========== FORM SUBMISSION ==========
    async function submitRequest(e) {
      e.preventDefault();

      if (!dataSdkReady) {
        showToast('‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...', 'info');
        return;
      }

      if (allRequests.length >= 999) {
        showToast('‚ùå ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•', 'error');
        return;
      }

      const name = document.getElementById('field-name').value.trim();
      const classroom = document.getElementById('field-class').value.trim();
      const date = document.getElementById('field-date').value;
      const timeOut = document.getElementById('field-time-out').value;
      const timeBack = document.getElementById('field-time-back').value || '';
      const reason = document.getElementById('field-reason').value.trim();
      const parentName = document.getElementById('field-parent-name').value.trim();
      const parentPhone = document.getElementById('field-parent-phone').value.trim();

      if (!name || !classroom || !date || !timeOut || !reason || !parentName || !parentPhone) {
        showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (*)', 'error');
        return;
      }

      const btn = document.getElementById('btn-submit');
      btn.disabled = true;
      btn.innerHTML = '<span class="inline-flex items-center gap-2"><span class="spinner"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...</span>';

      try {
        const result = await window.dataSdk.create({
          student_id: currentUser.id,
          citizen_id: currentUser.citizen,
          student_name: name,
          class_room: classroom,
          leave_date: date,
          leave_time: timeOut,
          return_time: timeBack,
          reason: reason,
          parent_name: parentName,
          parent_phone: parentPhone,
          parent_image: uploadedImage || '',
          status: 'pending',
          reject_reason: '',
          created_at: new Date().toISOString(),
          approved_by: '',
          approved_at: ''
        });

        if (result.isOk) {
          showToast('‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          document.getElementById('form-request').reset();
          clearUploadImage();
          setDefaultDate();
          setTimeout(() => switchStudentTab('history'), 1000);
        } else {
          const errorMsg = result.error?.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
          showToast(`‚ùå ${errorMsg}`, 'error');
          console.error('Submit error:', result.error);
        }
      } catch (err) {
        showToast(`‚ùå ${err.message}`, 'error');
        console.error('Catch error:', err);
      } finally {
        btn.disabled = false;
        btn.innerHTML = '‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠';
      }
    }

    // ========== STUDENT VIEW ==========
    function updateStudentView() {
      const display = document.getElementById('student-name-display');
      if (display) {
        display.textContent = `‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${currentUser.id} (${currentUser.citizen})`;
      }
    }

    function loadStudentHistory() {
      const myReqs = allRequests.filter(r => r.student_id === currentUser.id);
      const list = document.getElementById('history-list');

      if (myReqs.length === 0) {
        list.innerHTML = '<div class="text-center text-gray-400 py-12"><p class="text-lg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p></div>';
        return;
      }

      list.innerHTML = myReqs.map(r => `
        <div class="bg-gradient-to-r ${getStatusGradient(r.status)} rounded-lg shadow-md p-6 border-l-4 ${getStatusBorder(r.status)}">
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <p class="font-bold text-lg text-gray-800">üìÖ ${formatDate(r.leave_date)}</p>
              <p class="text-gray-700 mt-2">‚è∞ ${r.leave_time} ${r.return_time ? `- ${r.return_time}` : '(‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô)'}</p>
              <p class="text-gray-700 mt-2">üìù ${r.reason}</p>
            </div>
            <div class="text-center">
              <span class="inline-block px-4 py-2 rounded-full font-bold text-white ${getStatusColor(r.status)}">
                ${getStatusEmoji(r.status)} ${getStatusThai(r.status)}
              </span>
            </div>
          </div>
          ${r.reject_reason ? `<div class="mt-4 bg-red-100 border-l-4 border-red-500 p-3 rounded"><p class="text-red-700 font-semibold">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: ${r.reject_reason}</p></div>` : ''}
        </div>
      `).join('');
    }

    // ========== TEACHER VIEW ==========
    function updateTeacherView() {
      updateTeacherStats();
      renderTeacherRequests(allRequests);
    }

    function updateTeacherStats() {
      document.getElementById('stat-total').textContent = allRequests.length;
      document.getElementById('stat-pending').textContent = allRequests.filter(r => r.status === 'pending').length;
      document.getElementById('stat-approved').textContent = allRequests.filter(r => r.status === 'approved').length;
      document.getElementById('stat-rejected').textContent = allRequests.filter(r => r.status === 'rejected').length;
    }

    function filterRequests() {
      let filtered = allRequests;
      const search = document.getElementById('search-input').value.toLowerCase();
      const status = document.getElementById('status-select').value;
      const date = document.getElementById('date-select').value;

      if (search) {
        filtered = filtered.filter(r =>
          r.student_name.toLowerCase().includes(search) ||
          r.student_id.toLowerCase().includes(search) ||
          r.class_room.toLowerCase().includes(search)
        );
      }

      if (status) {
        filtered = filtered.filter(r => r.status === status);
      }

      if (date) {
        filtered = filtered.filter(r => r.leave_date === date);
      }

      renderTeacherRequests(filtered);
    }

    function renderTeacherRequests(reqs) {
      const list = document.getElementById('requests-list');

      if (reqs.length === 0) {
        list.innerHTML = '<div class="text-center text-gray-400 py-12"><p class="text-lg">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠</p></div>';
        return;
      }

      list.innerHTML = reqs.map(r => `
        <div class="bg-white rounded-lg shadow-md hover:shadow-lg p-6 border-l-4 ${getStatusBorder(r.status)} transition">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start">
            <div>
              <h4 class="text-xl font-bold text-gray-800">${r.student_name}</h4>
              <p class="text-gray-600">üîπ ‡∏£‡∏´‡∏±‡∏™: ${r.student_id}</p>
              <p class="text-gray-600">üîπ ‡∏ä‡∏±‡πâ‡∏ô: ${r.class_room}</p>
              <p class="text-gray-600 mt-3">üìÖ ${formatDate(r.leave_date)}</p>
              <p class="text-gray-600">‚è∞ ${r.leave_time} ${r.return_time ? `- ${r.return_time}` : ''}</p>
              <p class="text-gray-700 mt-2 font-semibold">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${r.reason}</p>
              <p class="text-gray-600 mt-2">üë® ‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á: ${r.parent_name}</p>
              <p class="text-gray-600">üìû ${r.parent_phone}</p>
            </div>

            <div class="text-center">
              <span class="inline-block px-4 py-3 rounded-full font-bold text-white text-lg ${getStatusColor(r.status)}">
                ${getStatusEmoji(r.status)} ${getStatusThai(r.status)}
              </span>
            </div>

            <div class="space-y-2">
              <button onclick="showDetailModal('${r.__backendId}')" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition">
                üìÑ ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
              </button>
              ${r.status === 'pending' ? `
                <button onclick="approveTeacherRequest('${r.__backendId}')" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition">
                  ‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                </button>
                <button onclick="openRejectModal('${r.__backendId}')" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition">
                  ‚ùå ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                </button>
              ` : ''}
            </div>
          </div>
        </div>
      `).join('');
    }

    // ========== MODALS ==========
    function showDetailModal(id) {
      const req = allRequests.find(r => r.__backendId === id);
      if (!req) return;

      const content = document.getElementById('modal-detail-content');
      content.innerHTML = `
        <div class="space-y-6">
          <div class="grid grid-cols-2 gap-4">
            <div class="bg-blue-50 p-4 rounded-lg">
              <p class="text-xs text-gray-600 font-semibold">‡∏ä‡∏∑‡πà‡∏≠</p>
              <p class="text-lg font-bold text-gray-800">${req.student_name}</p>
            </div>
            <div class="bg-blue-50 p-4 rounded-lg">
              <p class="text-xs text-gray-600 font-semibold">‡∏£‡∏´‡∏±‡∏™</p>
              <p class="text-lg font-bold text-gray-800">${req.student_id}</p>
            </div>
            <div class="bg-blue-50 p-4 rounded-lg">
              <p class="text-xs text-gray-600 font-semibold">‡∏ä‡∏±‡πâ‡∏ô</p>
              <p class="text-lg font-bold text-gray-800">${req.class_room}</p>
            </div>
            <div class="bg-blue-50 p-4 rounded-lg">
              <p class="text-xs text-gray-600 font-semibold">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</p>
              <p class="text-lg font-bold text-gray-800">${req.citizen_id}</p>
            </div>
          </div>

          <div class="border-t-2 border-gray-200 pt-6">
            <h4 class="text-lg font-bold text-gray-800 mb-4">üìÖ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏≤</h4>
            <div class="grid grid-cols-3 gap-3">
              <div class="bg-green-50 p-4 rounded-lg">
                <p class="text-xs text-gray-600 font-semibold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</p>
                <p class="text-lg font-bold text-green-700">${formatDate(req.leave_date)}</p>
              </div>
              <div class="bg-green-50 p-4 rounded-lg">
                <p class="text-xs text-gray-600 font-semibold">‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</p>
                <p class="text-lg font-bold text-green-700">${req.leave_time}</p>
              </div>
              <div class="bg-green-50 p-4 rounded-lg">
                <p class="text-xs text-gray-600 font-semibold">‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏•‡∏±‡∏ö</p>
                <p class="text-lg font-bold text-green-700">${req.return_time || '-'}</p>
              </div>
            </div>
            <div class="mt-4 bg-green-50 p-4 rounded-lg">
              <p class="text-xs text-gray-600 font-semibold mb-2">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</p>
              <p class="text-gray-800">${req.reason}</p>
            </div>
          </div>

          <div class="border-t-2 border-gray-200 pt-6">
            <h4 class="text-lg font-bold text-gray-800 mb-4">üë®‚Äçüë©‚Äçüëß ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</h4>
            <div class="grid grid-cols-2 gap-3">
              <div class="bg-orange-50 p-4 rounded-lg">
                <p class="text-xs text-gray-600 font-semibold">‡∏ä‡∏∑‡πà‡∏≠</p>
                <p class="text-lg font-bold text-gray-800">${req.parent_name}</p>
              </div>
              <div class="bg-orange-50 p-4 rounded-lg">
                <p class="text-xs text-gray-600 font-semibold">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</p>
                <p class="text-lg font-bold text-gray-800">${req.parent_phone}</p>
              </div>
            </div>
            ${req.parent_image ? `
              <div class="mt-4">
                <p class="text-sm font-semibold text-gray-600 mb-3">üì∏ ‡∏£‡∏π‡∏õ‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</p>
                <img src="${req.parent_image}" alt="Parent" class="w-full max-h-96 object-contain rounded-lg shadow">
              </div>
            ` : ''}
          </div>

          <div class="bg-${getStatusColorBg(req.status)} p-6 rounded-lg border-2 border-${getStatusBorderColor(req.status)}">
            <p class="text-sm font-semibold text-gray-600 mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</p>
            <p class="text-2xl font-bold ${getStatusColorText(req.status)}">
              ${getStatusEmoji(req.status)} ${getStatusThai(req.status)}
            </p>
            ${req.approved_by ? `<p class="text-sm text-gray-600 mt-3">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢: ${req.approved_by} ‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${formatDateTime(req.approved_at)}</p>` : ''}
            ${req.reject_reason ? `<div class="mt-4 bg-red-100 p-3 rounded border-l-4 border-red-500"><p class="font-semibold text-red-700">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥:</p><p class="text-red-700">${req.reject_reason}</p></div>` : ''}
          </div>
        </div>
      `;
      document.getElementById('modal-detail').classList.remove('hidden');
    }

    function closeDetailModal() {
      document.getElementById('modal-detail').classList.add('hidden');
    }

    function openRejectModal(id) {
      currentRejectId = id;
      document.getElementById('reject-reason-input').value = '';
      document.getElementById('modal-reject').classList.remove('hidden');
    }

    function closeRejectModal() {
      currentRejectId = null;
      document.getElementById('modal-reject').classList.add('hidden');
    }

    // ========== TEACHER ACTIONS ==========
    async function approveTeacherRequest(id) {
      const req = allRequests.find(r => r.__backendId === id);
      if (!req) return;

      try {
        const result = await window.dataSdk.update({
          ...req,
          status: 'approved',
          approved_by: '‡∏Ñ‡∏£‡∏π',
          approved_at: new Date().toISOString()
        });

        if (result.isOk) {
          showToast('‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          closeDetailModal();
        } else {
          showToast(`‚ùå ${result.error?.message}`, 'error');
        }
      } catch (err) {
        showToast(`‚ùå ${err.message}`, 'error');
      }
    }

    async function submitReject() {
      const reason = document.getElementById('reject-reason-input').value.trim();
      if (!reason) {
        showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•', 'error');
        return;
      }

      const req = allRequests.find(r => r.__backendId === currentRejectId);
      if (!req) return;

      try {
        const result = await window.dataSdk.update({
          ...req,
          status: 'rejected',
          reject_reason: reason,
          approved_by: '‡∏Ñ‡∏£‡∏π',
          approved_at: new Date().toISOString()
        });

        if (result.isOk) {
          showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          closeRejectModal();
          closeDetailModal();
        } else {
          showToast(`‚ùå ${result.error?.message}`, 'error');
        }
      } catch (err) {
        showToast(`‚ùå ${err.message}`, 'error');
      }
    }

    // ========== UTILITIES ==========
    function clearAllInputs() {
      document.querySelectorAll('input, textarea').forEach(el => el.value = '');
      document.getElementById('file-input').value = '';
      clearUploadImage();
    }

    function updateAllViews() {
      if (currentRole === 'teacher') updateTeacherView();
      else if (currentRole === 'student' && !document.getElementById('student-tab-history').classList.contains('hidden')) loadStudentHistory();
    }

    function updateAppTitle() {
      const title = document.getElementById('app-title');
      if (title) title.textContent = config.school_name || defaultConfig.school_name;
    }

    function formatDate(str) {
      if (!str) return '-';
      const date = new Date(str + 'T00:00:00');
      return new Intl.DateTimeFormat('th-TH', { year: 'numeric', month: 'short', day: 'numeric' }).format(date);
    }

    function formatDateTime(str) {
      if (!str) return '-';
      const date = new Date(str);
      return new Intl.DateTimeFormat('th-TH', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }).format(date);
    }

    function getStatusColor(status) {
      return status === 'pending' ? 'bg-yellow-500' : status === 'approved' ? 'bg-green-500' : 'bg-red-500';
    }

    function getStatusGradient(status) {
      return status === 'pending' ? 'from-yellow-50 to-yellow-100' : status === 'approved' ? 'from-green-50 to-green-100' : 'from-red-50 to-red-100';
    }

    function getStatusBorder(status) {
      return status === 'pending' ? 'border-yellow-500' : status === 'approved' ? 'border-green-500' : 'border-red-500';
    }

    function getStatusBorderColor(status) {
      return status === 'pending' ? 'yellow-300' : status === 'approved' ? 'green-300' : 'red-300';
    }

    function getStatusColorBg(status) {
      return status === 'pending' ? 'yellow-50' : status === 'approved' ? 'green-50' : 'red-50';
    }

    function getStatusColorText(status) {
      return status === 'pending' ? 'text-yellow-700' : status === 'approved' ? 'text-green-700' : 'text-red-700';
    }

    function getStatusEmoji(status) {
      return status === 'pending' ? '‚è≥' : status === 'approved' ? '‚úÖ' : '‚ùå';
    }

    function getStatusThai(status) {
      return status === 'pending' ? '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' : status === 'approved' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß' : '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
    }

    // Start
    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9cb830dda48998e2',t:'MTc3MDY5MDY5My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
